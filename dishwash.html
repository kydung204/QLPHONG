<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N∆∞·ªõc r·ª≠a b√°t - Qu·∫£n l√Ω nh√† chung</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-brand">
                <h2>üè† Qu·∫£n l√Ω nh√† chung</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">üè† Trang ch·ªß</a></li>
                <li><a href="water.html">üíß ƒê·ªïi n∆∞·ªõc</a></li>
                <li><a href="toothpaste.html">ü¶∑ Kem ƒë√°nh rƒÉng</a></li>
                <li><a href="dishwash.html" class="active">üßΩ N∆∞·ªõc r·ª≠a b√°t</a></li>
                <li><a href="debt.html">üí∞ T√≠nh n·ª£</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div class="page-header">
            <h1>üßΩ Qu·∫£n l√Ω n∆∞·ªõc r·ª≠a b√°t</h1>
        </div>

        <div class="rotation-card">
            <div class="item-image">
                <img src="/placeholder.svg?height=200&width=200" alt="N∆∞·ªõc r·ª≠a b√°t" class="item-img">
            </div>
            
            <div class="rotation-info">
                <div class="info-item">
                    <label>Ng∆∞·ªùi mua tr∆∞·ªõc:</label>
                    <span id="previousPerson">ƒêang t·∫£i...</span>
                </div>
                
                <div class="info-item current">
                    <label>Ng∆∞·ªùi ƒëang mua:</label>
                    <span id="currentPerson">ƒêang t·∫£i...</span>
                </div>
                
                <div class="info-item">
                    <label>Ng∆∞·ªùi s·∫Ω mua k·∫ø ti·∫øp:</label>
                    <span id="nextPerson">ƒêang t·∫£i...</span>
                </div>
            </div>
            
            <div class="action-section">
                <button id="completeBtn" class="btn btn-success">‚úÖ ƒê√£ mua</button>
            </div>
        </div>

        <div class="history-section">
            <h3>L·ªãch s·ª≠ mua n∆∞·ªõc r·ª≠a b√°t</h3>
            <div id="historyList" class="history-list">
                <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBb9dnBAgu7YBSnaRbty5CxPzM3Dvj-gi0",
            authDomain: "webtinhno.firebaseapp.com",
            databaseURL: "https://webtinhno-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "webtinhno",
            storageBucket: "webtinhno.firebasestorage.app",
            messagingSenderId: "816939347254",
            appId: "1:816939347254:web:b684dcbbcb2bbaf4c95797"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Danh s√°ch th√†nh vi√™n
        const MEMBERS = {
            A: "D≈©ng",
            B: "Quang", 
            C: "VƒÉn",
            D: "C∆∞·ªùng"
        };

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('vi-VN');
        }

        // Qu·∫£n l√Ω n∆∞·ªõc r·ª≠a b√°t
        class DishwashManager {
            constructor() {
                this.dbRef = database.ref('dishwashRotation');
                this.init();
            }

            async init() {
                try {
                    console.log('ƒêang kh·ªüi t·∫°o DishwashManager...');
                    
                    const snapshot = await this.dbRef.once('value');
                    if (!snapshot.exists()) {
                        console.log('T·∫°o d·ªØ li·ªáu m·∫∑c ƒë·ªãnh...');
                        await this.dbRef.set({
                            people: ["A", "B", "C", "D"],
                            currentIndex: 0,
                            history: []
                        });
                    }

                    this.loadData();
                    this.setupEventListeners();
                } catch (error) {
                    console.error('L·ªói kh·ªüi t·∫°o:', error);
                    alert('L·ªói k·∫øt n·ªëi Firebase: ' + error.message);
                }
            }

            async loadData() {
                try {
                    const snapshot = await this.dbRef.once('value');
                    const data = snapshot.val();
                    
                    console.log('D·ªØ li·ªáu t·ª´ Firebase:', data);

                    if (data) {
                        this.updateDisplay(data);
                        this.loadHistory(data.history || []);
                    }
                } catch (error) {
                    console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                }
            }

            updateDisplay(data) {
                const { people, currentIndex } = data;
                const currentPerson = people[currentIndex];
                const previousIndex = (currentIndex - 1 + people.length) % people.length;
                const nextIndex = (currentIndex + 1) % people.length;

                document.getElementById('previousPerson').textContent = MEMBERS[people[previousIndex]];
                document.getElementById('currentPerson').textContent = MEMBERS[currentPerson];
                document.getElementById('nextPerson').textContent = MEMBERS[people[nextIndex]];
            }

            loadHistory(history) {
                const historyList = document.getElementById('historyList');

                if (!history || history.length === 0) {
                    historyList.innerHTML = '<p>Ch∆∞a c√≥ l·ªãch s·ª≠ mua n∆∞·ªõc r·ª≠a b√°t</p>';
                    return;
                }

                const sortedHistory = history.sort((a, b) => b.timestamp - a.timestamp);

                historyList.innerHTML = sortedHistory.map(item => `
                    <div class="history-item">
                        <span><strong>${MEMBERS[item.by]}</strong> ƒë√£ mua n∆∞·ªõc r·ª≠a b√°t</span>
                        <span>${formatDate(item.timestamp)}</span>
                    </div>
                `).join('');
            }

            async completeRotation() {
                try {
                    const snapshot = await this.dbRef.once('value');
                    const data = snapshot.val();

                    if (data) {
                        const { people, currentIndex, history = [] } = data;
                        const currentPerson = people[currentIndex];
                        const newIndex = (currentIndex + 1) % people.length;

                        const newHistoryItem = {
                            by: currentPerson,
                            timestamp: Date.now()
                        };

                        const updatedHistory = [newHistoryItem, ...history];

                        await this.dbRef.update({
                            currentIndex: newIndex,
                            history: updatedHistory
                        });

                        this.loadData();
                        alert(`${MEMBERS[currentPerson]} ƒë√£ ho√†n th√†nh vi·ªác mua n∆∞·ªõc r·ª≠a b√°t!`);
                    }
                } catch (error) {
                    console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            }

            setupEventListeners() {
                document.getElementById('completeBtn').addEventListener('click', () => {
                    if (confirm('X√°c nh·∫≠n ƒë√£ mua n∆∞·ªõc r·ª≠a b√°t?')) {
                        this.completeRotation();
                    }
                });
            }
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', () => {
            new DishwashManager();
        });
    </script>
</body>
</html>
