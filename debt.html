<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√≠nh n·ª£ - Qu·∫£n l√Ω nh√† chung</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-brand">
                <h2>üè† Qu·∫£n l√Ω nh√† chung</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">üè† Trang ch·ªß</a></li>
                <li><a href="water.html">üíß ƒê·ªïi n∆∞·ªõc</a></li>
                <li><a href="toothpaste.html">ü¶∑ Kem ƒë√°nh rƒÉng</a></li>
                <li><a href="dishwash.html">üßΩ N∆∞·ªõc r·ª≠a b√°t</a></li>
                <li><a href="debt.html" class="active">üí∞ T√≠nh n·ª£</a></li>
            </ul>
        </nav>
    </header>

    <main class="container debt-container">
        <div class="page-header">
            <h1>üí∞ Qu·∫£n l√Ω t√≠nh n·ª£</h1>
        </div>

        <div class="debt-layout">
            <div class="sidebar">
                <h3>Danh s√°ch th√†nh vi√™n</h3>
                <div class="member-list">
                    <div class="member-item active" data-member="A">
                        <span class="member-name">D≈©ng</span>
                    </div>
                    <div class="member-item" data-member="B">
                        <span class="member-name">Quang</span>
                    </div>
                    <div class="member-item" data-member="C">
                        <span class="member-name">VƒÉn</span>
                    </div>
                    <div class="member-item" data-member="D">
                        <span class="member-name">C∆∞·ªùng</span>
                    </div>
                </div>

                <!-- Th√™m ph·∫ßn qu·∫£n l√Ω d·ªØ li·ªáu -->
                <div class="data-management">
                    <h4>Qu·∫£n l√Ω d·ªØ li·ªáu</h4>
                    <button id="cleanupBtn" class="btn btn-warning">üóëÔ∏è X√≥a d·ªØ li·ªáu c≈© (>6 th√°ng)</button>
                    <button id="exportBtn" class="btn btn-info">üìä Xu·∫•t b√°o c√°o</button>
                    <div class="data-stats">
                        <small id="dataStats">ƒêang t·∫£i th·ªëng k√™...</small>
                    </div>
                </div>

                <div class="calculator">
                    <h4>üßÆ M√°y t√≠nh</h4>
                    <div class="calc-display">
                        <input type="text" id="calcDisplay" readonly value="0">
                    </div>
                    <div class="calc-buttons">
                        <button class="calc-btn calc-clear" onclick="clearCalc()">C</button>
                        <button class="calc-btn calc-operator" onclick="appendCalc('/')">/</button>
                        <button class="calc-btn calc-operator" onclick="appendCalc('*')">√ó</button>
                        <button class="calc-btn calc-operator" onclick="deleteLast()">‚å´</button>
                        
                        <button class="calc-btn calc-number" onclick="appendCalc('7')">7</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('8')">8</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('9')">9</button>
                        <button class="calc-btn calc-operator" onclick="appendCalc('-')">-</button>
                        
                        <button class="calc-btn calc-number" onclick="appendCalc('4')">4</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('5')">5</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('6')">6</button>
                        <button class="calc-btn calc-operator" onclick="appendCalc('+')">+</button>
                        
                        <button class="calc-btn calc-number" onclick="appendCalc('1')">1</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('2')">2</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('3')">3</button>
                        <button class="calc-btn calc-equals" onclick="calculateResult()" rowspan="2">=</button>
                        
                        <button class="calc-btn calc-number calc-zero" onclick="appendCalc('0')">0</button>
                        <button class="calc-btn calc-number" onclick="appendCalc('.')">.</button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="member-info">
                    <h2 id="selectedMemberName">D≈©ng</h2>
                    
                    <div class="debt-summary">
                        <div class="debt-section">
                            <h3>üí∏ Nh·ªØng ng∆∞·ªùi n·ª£ h·ªç</h3>
                            <div id="owedToThem" class="debt-list">
                                <p>ƒêang t·∫£i...</p>
                            </div>
                        </div>
                        
                        <div class="debt-section">
                            <h3>üí≥ H·ªç ƒëang n·ª£</h3>
                            <div id="theyOwe" class="debt-list">
                                <p>ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="expense-form">
                    <h3>Chia ti·ªÅn m·ªõi</h3>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label for="itemName">M√≥n ƒë·ªì mua:</label>
                            <input type="text" id="itemName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="amount">S·ªë ti·ªÅn (VNƒê):</label>
                            <input type="number" id="amount" required min="1000">
                        </div>
                        
                        <div class="form-group">
                            <label for="payer">Ng∆∞·ªùi tr·∫£ ti·ªÅn:</label>
                            <select id="payer" required>
                                <option value="A">D≈©ng</option>
                                <option value="B">Quang</option>
                                <option value="C">VƒÉn</option>
                                <option value="D">C∆∞·ªùng</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Chia v·ªõi (ch·ªçn t·ªëi ƒëa 3 ng∆∞·ªùi):</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" value="A"> D≈©ng</label>
                                <label><input type="checkbox" value="B"> Quang</label>
                                <label><input type="checkbox" value="C"> VƒÉn</label>
                                <label><input type="checkbox" value="D"> C∆∞·ªùng</label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Chia ti·ªÅn</button>
                    </form>
                </div>

                <div class="manual-debt">
    <h3>Tr·ª´ n·ª£ th·ªß c√¥ng</h3>
    <form id="manualDebtForm">
        <div class="form-row">
            <select id="debtor" required>
                <option value="">Ng∆∞·ªùi n·ª£</option>
                <option value="A">D≈©ng</option>
                <option value="B">Quang</option>
                <option value="C">VƒÉn</option>
                <option value="D">C∆∞·ªùng</option>
            </select>
            
            <select id="creditor" required>
                <option value="">Ng∆∞·ªùi cho n·ª£</option>
                <option value="A">D≈©ng</option>
                <option value="B">Quang</option>
                <option value="C">VƒÉn</option>
                <option value="D">C∆∞·ªùng</option>
            </select>
            
            <input type="number" id="debtAmount" placeholder="S·ªë ti·ªÅn tr·∫£" required min="1000">
            
            <div class="form-row-buttons">
                <button type="submit" class="btn btn-secondary">Tr·ª´ n·ª£</button>
                <button type="button" id="clearAllDebtBtn" class="btn btn-danger">üóëÔ∏è X√≥a to√†n b·ªô n·ª£</button>
            </div>
        </div>
    </form>
</div>

                <div class="loan-money">
    <h3>N·ª£ ti·ªÅn (Cho vay)</h3>
    <form id="loanForm">
        <div class="form-row">
            <select id="lender" required>
                <option value="">Ng∆∞·ªùi cho vay</option>
                <option value="A">D≈©ng</option>
                <option value="B">Quang</option>
                <option value="C">VƒÉn</option>
                <option value="D">C∆∞·ªùng</option>
            </select>
            
            <select id="borrower" required>
                <option value="">Ng∆∞·ªùi vay</option>
                <option value="A">D≈©ng</option>
                <option value="B">Quang</option>
                <option value="C">VƒÉn</option>
                <option value="D">C∆∞·ªùng</option>
            </select>
            
            <input type="number" id="loanAmount" placeholder="S·ªë ti·ªÅn cho vay" required min="1000">
            
            <div class="form-row-buttons">
                <button type="submit" class="btn btn-primary">Ghi n·ª£</button>
            </div>
        </div>
    </form>
</div>
            </div>
        </div>

        <div class="transaction-history">
            <h3>L·ªãch s·ª≠ giao d·ªãch</h3>
            <div class="history-filter">
                <select id="timeFilter">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="30">30 ng√†y g·∫ßn nh·∫•t</option>
                    <option value="90">3 th√°ng g·∫ßn nh·∫•t</option>
                    <option value="180">6 th√°ng g·∫ßn nh·∫•t</option>
                </select>
            </div>
            <div id="transactionList" class="transaction-list">
                <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBb9dnBAgu7YBSnaRbty5CxPzM3Dvj-gi0",
            authDomain: "webtinhno.firebaseapp.com",
            databaseURL: "https://webtinhno-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "webtinhno",
            storageBucket: "webtinhno.firebasestorage.app",
            messagingSenderId: "816939347254",
            appId: "1:816939347254:web:b684dcbbcb2bbaf4c95797"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Danh s√°ch th√†nh vi√™n
        const MEMBERS = {
            A: "D≈©ng",
            B: "Quang", 
            C: "VƒÉn",
            D: "C∆∞·ªùng"
        };

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('vi-VN');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Qu·∫£n l√Ω t√≠nh n·ª£ v·ªõi t√≠nh nƒÉng d·ªçn d·∫πp d·ªØ li·ªáu
        class DebtManager {
            constructor() {
                this.debtsRef = database.ref('debts');
                this.transactionsRef = database.ref('transactions');
                this.selectedMember = 'A';
                this.timeFilter = 'all';
                this.init();
            }

            async init() {
                try {
                    console.log('ƒêang kh·ªüi t·∫°o DebtManager...');
                    await this.loadData();
                    this.setupEventListeners();
                    this.updateDataStats();
                    
                    // T·ª± ƒë·ªông d·ªçn d·∫πp khi kh·ªüi t·∫°o (t√πy ch·ªçn)
                    // await this.autoCleanup();
                } catch (error) {
                    console.error('L·ªói kh·ªüi t·∫°o:', error);
                    alert('L·ªói k·∫øt n·ªëi Firebase: ' + error.message);
                }
            }

            async loadData() {
                try {
                    const [debtsSnapshot, transactionsSnapshot] = await Promise.all([
                        this.debtsRef.once('value'),
                        this.transactionsRef.once('value')
                    ]);

                    this.debts = debtsSnapshot.val() || {};
                    this.transactions = transactionsSnapshot.val() || {};

                    console.log('Debts:', this.debts);
                    console.log('Transactions:', this.transactions);

                    this.updateMemberInfo();
                    this.loadTransactionHistory();
                } catch (error) {
                    console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                }
            }

            updateMemberInfo() {
                const memberName = MEMBERS[this.selectedMember];
                document.getElementById('selectedMemberName').textContent = memberName;

                const owedToThem = [];
                const theyOwe = [];

                Object.keys(this.debts).forEach(key => {
                    const amount = this.debts[key];
                    if (amount > 0) {
                        const [debtor, creditor] = key.split('_');

                        if (creditor === this.selectedMember) {
                            owedToThem.push({
                                person: MEMBERS[debtor],
                                amount: amount
                            });
                        } else if (debtor === this.selectedMember) {
                            theyOwe.push({
                                person: MEMBERS[creditor],
                                amount: amount
                            });
                        }
                    }
                });

                this.displayDebtList('owedToThem', owedToThem);
                this.displayDebtList('theyOwe', theyOwe);
            }

            displayDebtList(elementId, debtList) {
                const element = document.getElementById(elementId);

                if (debtList.length === 0) {
                    element.innerHTML = '<p>Kh√¥ng c√≥ kho·∫£n n·ª£ n√†o</p>';
                    return;
                }

                element.innerHTML = debtList.map(debt => `
                    <div class="debt-item">
                        <span>${debt.person}</span>
                        <span class="debt-amount">${formatCurrency(debt.amount)}</span>
                    </div>
                `).join('');
            }

            loadTransactionHistory() {
                const transactionList = document.getElementById('transactionList');
                const transactionArray = Object.values(this.transactions);

                if (transactionArray.length === 0) {
                    transactionList.innerHTML = '<p>Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
                    return;
                }

                // L·ªçc theo th·ªùi gian
                let filteredTransactions = transactionArray;
                if (this.timeFilter !== 'all') {
                    const cutoffTime = Date.now() - (parseInt(this.timeFilter) * 24 * 60 * 60 * 1000);
                    filteredTransactions = transactionArray.filter(t => t.timestamp > cutoffTime);
                }

                const sortedTransactions = filteredTransactions.sort((a, b) => b.timestamp - a.timestamp);

                transactionList.innerHTML = sortedTransactions.map(transaction => {
                    let description = '';
                    
                    if (transaction.type === 'loan') {
                        description = `${MEMBERS[transaction.payer]} cho ${MEMBERS[transaction.sharedWith[0]]} vay ti·ªÅn`;
                    } else if (transaction.type === 'payment') {
                        description = `${MEMBERS[transaction.payer]} tr·∫£ n·ª£ cho ${MEMBERS[transaction.sharedWith[0]]}`;
                    } else {
                        description = `${MEMBERS[transaction.payer]} tr·∫£ ti·ªÅn ‚Ä¢ Chia v·ªõi: ${transaction.sharedWith.map(p => MEMBERS[p]).join(', ')}`;
                    }

                    return `
                        <div class="transaction-item">
                            <div class="transaction-header">
                                <span class="transaction-title">${transaction.item}</span>
                                <span class="transaction-amount">${formatCurrency(transaction.amount)}</span>
                            </div>
                            <div class="transaction-details">
                                ${description} ‚Ä¢ ${formatDate(transaction.timestamp)}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // C·∫≠p nh·∫≠t th·ªëng k√™ d·ªØ li·ªáu
            updateDataStats() {
                const transactionCount = Object.keys(this.transactions).length;
                const oldestTransaction = Math.min(...Object.values(this.transactions).map(t => t.timestamp));
                const oldestDate = oldestTransaction ? new Date(oldestTransaction).toLocaleDateString('vi-VN') : 'N/A';
                
                document.getElementById('dataStats').innerHTML = `
                    ${transactionCount} giao d·ªãch ‚Ä¢ C≈© nh·∫•t: ${oldestDate}
                `;
            }

            // D·ªçn d·∫πp d·ªØ li·ªáu c≈© (>6 th√°ng)
            async cleanupOldData() {
                try {
                    const sixMonthsAgo = Date.now() - (6 * 30 * 24 * 60 * 60 * 1000);
                    const transactionsToDelete = [];
                    
                    Object.entries(this.transactions).forEach(([id, transaction]) => {
                        if (transaction.timestamp < sixMonthsAgo) {
                            transactionsToDelete.push(id);
                        }
                    });

                    if (transactionsToDelete.length === 0) {
                        alert('Kh√¥ng c√≥ d·ªØ li·ªáu c≈© h∆°n 6 th√°ng ƒë·ªÉ x√≥a!');
                        return;
                    }

                    if (confirm(`S·∫Ω x√≥a ${transactionsToDelete.length} giao d·ªãch c≈© h∆°n 6 th√°ng. Ti·∫øp t·ª•c?`)) {
                        const deletePromises = transactionsToDelete.map(id => 
                            this.transactionsRef.child(id).remove()
                        );
                        
                        await Promise.all(deletePromises);
                        await this.loadData();
                        this.updateDataStats();
                        
                        alert(`ƒê√£ x√≥a ${transactionsToDelete.length} giao d·ªãch c≈©!`);
                    }
                } catch (error) {
                    console.error('L·ªói d·ªçn d·∫πp:', error);
                    alert('C√≥ l·ªói khi d·ªçn d·∫πp d·ªØ li·ªáu!');
                }
            }

            // T·ª± ƒë·ªông d·ªçn d·∫πp (ch·∫°y khi kh·ªüi t·∫°o)
            async autoCleanup() {
                const oneYearAgo = Date.now() - (365 * 24 * 60 * 60 * 1000);
                const transactionsToDelete = [];
                
                Object.entries(this.transactions).forEach(([id, transaction]) => {
                    if (transaction.timestamp < oneYearAgo) {
                        transactionsToDelete.push(id);
                    }
                });

                if (transactionsToDelete.length > 0) {
                    console.log(`T·ª± ƒë·ªông x√≥a ${transactionsToDelete.length} giao d·ªãch c≈© h∆°n 1 nƒÉm`);
                    const deletePromises = transactionsToDelete.map(id => 
                        this.transactionsRef.child(id).remove()
                    );
                    await Promise.all(deletePromises);
                }
            }

            // Xu·∫•t b√°o c√°o
            exportReport() {
                const transactions = Object.values(this.transactions);
                const report = transactions.map(t => ({
                    'Ng√†y': formatDate(t.timestamp),
                    'M√≥n ƒë·ªì': t.item,
                    'S·ªë ti·ªÅn': t.amount,
                    'Ng∆∞·ªùi tr·∫£': MEMBERS[t.payer],
                    'Chia v·ªõi': t.sharedWith.map(p => MEMBERS[p]).join(', ')
                }));

                const csv = this.convertToCSV(report);
                this.downloadCSV(csv, 'bao-cao-giao-dich.csv');
            }

            convertToCSV(data) {
                const headers = Object.keys(data[0]).join(',');
                const rows = data.map(row => Object.values(row).join(','));
                return [headers, ...rows].join('\n');
            }

            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            async addExpense(expenseData) {
                try {
                    const { itemName, amount, payer, sharedWith } = expenseData;
                    const totalPeople = sharedWith.length + 1;
                    const perPerson = Math.floor(amount / totalPeople);

                    const transactionId = Date.now().toString();

                    const transaction = {
                        id: transactionId,
                        item: itemName,
                        amount: amount,
                        payer: payer,
                        sharedWith: sharedWith,
                        perPerson: perPerson,
                        timestamp: Date.now()
                    };

                    await this.transactionsRef.child(transactionId).set(transaction);

                    const debtUpdates = {};

                    sharedWith.forEach(person => {
                        if (person !== payer) {
                            const debtKey = `${person}_${payer}`;
                            const currentDebt = this.debts[debtKey] || 0;
                            debtUpdates[debtKey] = currentDebt + perPerson;
                        }
                    });

                    if (Object.keys(debtUpdates).length > 0) {
                        await this.debtsRef.update(debtUpdates);
                    }

                    await this.loadData();
                    this.updateDataStats();
                    alert('ƒê√£ chia ti·ªÅn th√†nh c√¥ng!');
                } catch (error) {
                    console.error('L·ªói th√™m chi ph√≠:', error);
                    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            }

            async payDebt(debtor, creditor, amount) {
                try {
                    const debtKey = `${debtor}_${creditor}`;
                    const currentDebt = this.debts[debtKey] || 0;

                    if (currentDebt < amount) {
                        alert('S·ªë ti·ªÅn tr·∫£ l·ªõn h∆°n s·ªë n·ª£ hi·ªán t·∫°i!');
                        return;
                    }

                    const newDebt = currentDebt - amount;

                    // C·∫≠p nh·∫≠t n·ª£
                    if (newDebt === 0) {
                        await this.debtsRef.child(debtKey).remove();
                    } else {
                        await this.debtsRef.child(debtKey).set(newDebt);
                    }

                    // Th√™m v√†o l·ªãch s·ª≠ giao d·ªãch
                    const transactionId = Date.now().toString();
                    const transaction = {
                        id: transactionId,
                        item: "Tr·∫£ n·ª£",
                        amount: amount,
                        payer: debtor,
                        sharedWith: [creditor],
                        perPerson: amount,
                        timestamp: Date.now(),
                        type: "payment"
                    };

                    await this.transactionsRef.child(transactionId).set(transaction);

                    await this.loadData();
                    this.updateDataStats();
                    alert(`${MEMBERS[debtor]} ƒë√£ tr·∫£ ${formatCurrency(amount)} cho ${MEMBERS[creditor]}!`);
                } catch (error) {
                    console.error('L·ªói tr·∫£ n·ª£:', error);
                    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            }

            async addLoan(lender, borrower, amount) {
                try {
                    const debtKey = `${borrower}_${lender}`;
                    const currentDebt = this.debts[debtKey] || 0;
                    const newDebt = currentDebt + amount;

                    // C·∫≠p nh·∫≠t n·ª£
                    await this.debtsRef.child(debtKey).set(newDebt);

                    // Th√™m v√†o l·ªãch s·ª≠ giao d·ªãch
                    const transactionId = Date.now().toString();
                    const transaction = {
                        id: transactionId,
                        item: "N·ª£ ti·ªÅn (Cho vay)",
                        amount: amount,
                        payer: lender,
                        sharedWith: [borrower],
                        perPerson: amount,
                        timestamp: Date.now(),
                        type: "loan"
                    };

                    await this.transactionsRef.child(transactionId).set(transaction);

                    await this.loadData();
                    this.updateDataStats();
                    alert(`${MEMBERS[lender]} ƒë√£ cho ${MEMBERS[borrower]} vay ${formatCurrency(amount)}!`);
                } catch (error) {
                    console.error('L·ªói khi ghi n·ª£:', error);
                    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            }

            // H√†m x√≥a to√†n b·ªô n·ª£
            async clearAllDebt(debtor, creditor) {
                try {
                    const debtKey = `${debtor}_${creditor}`;
                    const currentDebt = this.debts[debtKey] || 0;

                    if (currentDebt === 0) {
                        alert('Kh√¥ng c√≥ kho·∫£n n·ª£ n√†o ƒë·ªÉ x√≥a!');
                        return;
                    }

                    if (confirm(`X√°c nh·∫≠n x√≥a to√†n b·ªô n·ª£ ${formatCurrency(currentDebt)} c·ªßa ${MEMBERS[debtor]} cho ${MEMBERS[creditor]}?`)) {
                        // X√≥a n·ª£
                        await this.debtsRef.child(debtKey).remove();

                        // Th√™m v√†o l·ªãch s·ª≠
                        const transactionId = Date.now().toString();
                        const transaction = {
                            id: transactionId,
                            item: "X√≥a to√†n b·ªô n·ª£",
                            amount: currentDebt,
                            payer: debtor,
                            sharedWith: [creditor],
                            perPerson: currentDebt,
                            timestamp: Date.now(),
                            type: "payment"
                        };

                        await this.transactionsRef.child(transactionId).set(transaction);

                        await this.loadData();
                        this.updateDataStats();
                        alert(`ƒê√£ x√≥a to√†n b·ªô n·ª£ ${formatCurrency(currentDebt)} c·ªßa ${MEMBERS[debtor]} cho ${MEMBERS[creditor]}!`);
                    }
                } catch (error) {
                    console.error('L·ªói x√≥a n·ª£:', error);
                    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                }
            }

            setupEventListeners() {
                // Member selection
                document.querySelectorAll('.member-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        document.querySelectorAll('.member-item').forEach(i => i.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.selectedMember = e.currentTarget.dataset.member;
                        this.updateMemberInfo();
                    });
                });

                // Time filter
                document.getElementById('timeFilter').addEventListener('change', (e) => {
                    this.timeFilter = e.target.value;
                    this.loadTransactionHistory();
                });

                // Cleanup button
                document.getElementById('cleanupBtn').addEventListener('click', () => {
                    this.cleanupOldData();
                });

                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportReport();
                });

                // Expense form
                document.getElementById('expenseForm').addEventListener('submit', (e) => {
                    e.preventDefault();

                    const itemName = document.getElementById('itemName').value;
                    const amount = parseInt(document.getElementById('amount').value);
                    const payer = document.getElementById('payer').value;
                    const sharedWith = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(cb => cb.value)
                        .filter(person => person !== payer);

                    if (sharedWith.length === 0) {
                        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng∆∞·ªùi ƒë·ªÉ chia ti·ªÅn!');
                        return;
                    }

                    if (sharedWith.length > 3) {
                        alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 3 ng∆∞·ªùi ƒë·ªÉ chia ti·ªÅn!');
                        return;
                    }

                    this.addExpense({
                        itemName,
                        amount,
                        payer,
                        sharedWith
                    });

                    e.target.reset();
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                });

                // Manual debt form
                document.getElementById('manualDebtForm').addEventListener('submit', (e) => {
                    e.preventDefault();

                    const debtor = document.getElementById('debtor').value;
                    const creditor = document.getElementById('creditor').value;
                    const amount = parseInt(document.getElementById('debtAmount').value);

                    if (debtor === creditor) {
                        alert('Ng∆∞·ªùi n·ª£ v√† ng∆∞·ªùi cho n·ª£ kh√¥ng th·ªÉ gi·ªëng nhau!');
                        return;
                    }

                    if (confirm(`X√°c nh·∫≠n ${MEMBERS[debtor]} tr·∫£ ${formatCurrency(amount)} cho ${MEMBERS[creditor]}?`)) {
                        this.payDebt(debtor, creditor, amount);
                        e.target.reset();
                    }
                });

                // Loan form
                document.getElementById('loanForm').addEventListener('submit', (e) => {
                    e.preventDefault();

                    const lender = document.getElementById('lender').value;
                    const borrower = document.getElementById('borrower').value;
                    const amount = parseInt(document.getElementById('loanAmount').value);

                    if (lender === borrower) {
                        alert('Ng∆∞·ªùi cho vay v√† ng∆∞·ªùi vay kh√¥ng th·ªÉ gi·ªëng nhau!');
                        return;
                    }

                    if (confirm(`X√°c nh·∫≠n ${MEMBERS[lender]} cho ${MEMBERS[borrower]} vay ${formatCurrency(amount)}?`)) {
                        this.addLoan(lender, borrower, amount);
                        e.target.reset();
                    }
                });

                // Clear all debt button
                document.getElementById('clearAllDebtBtn').addEventListener('click', () => {
                    const debtor = document.getElementById('debtor').value;
                    const creditor = document.getElementById('creditor').value;

                    if (!debtor || !creditor) {
                        alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi n·ª£ v√† ng∆∞·ªùi cho n·ª£!');
                        return;
                    }

                    if (debtor === creditor) {
                        alert('Ng∆∞·ªùi n·ª£ v√† ng∆∞·ªùi cho n·ª£ kh√¥ng th·ªÉ gi·ªëng nhau!');
                        return;
                    }

                    this.clearAllDebt(debtor, creditor);
                });
            }
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', () => {
            new DebtManager();
        });

        // Calculator functions
        let calcDisplay = '';
        let shouldResetDisplay = false;

        function appendCalc(value) {
            const display = document.getElementById('calcDisplay');
            
            if (shouldResetDisplay) {
                display.value = '';
                shouldResetDisplay = false;
            }
            
            if (display.value === '0' && value !== '.') {
                display.value = value;
            } else {
                display.value += value;
            }
        }

        function clearCalc() {
            document.getElementById('calcDisplay').value = '0';
            shouldResetDisplay = false;
        }

        function deleteLast() {
            const display = document.getElementById('calcDisplay');
            if (display.value.length > 1) {
                display.value = display.value.slice(0, -1);
            } else {
                display.value = '0';
            }
        }

        function calculateResult() {
            const display = document.getElementById('calcDisplay');
            try {
                // Thay th·∫ø √ó b·∫±ng * ƒë·ªÉ t√≠nh to√°n
                const expression = display.value.replace(/√ó/g, '*');
                const result = eval(expression);
                display.value = result;
                shouldResetDisplay = true;
            } catch (error) {
                display.value = 'Error';
                shouldResetDisplay = true;
            }
        }
    </script>
    <style>
        /* Calculator Styles */
        .calculator {
            border-top: 2px solid #e2e8f0;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .calculator h4 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .calc-display {
            margin-bottom: 0.5rem;
        }

        .calc-display input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: right;
            background: #f8fafc;
            font-family: monospace;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.25rem;
        }

        .calc-btn {
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-number {
            background: #f1f5f9;
            color: #1e293b;
        }

        .calc-number:hover {
            background: #e2e8f0;
        }

        .calc-operator {
            background: #3b82f6;
            color: white;
        }

        .calc-operator:hover {
            background: #2563eb;
        }

        .calc-equals {
            background: #10b981;
            color: white;
            grid-row: span 2;
        }

        .calc-equals:hover {
            background: #059669;
        }

        .calc-clear {
            background: #ef4444;
            color: white;
        }

        .calc-clear:hover {
            background: #dc2626;
        }

        .calc-zero {
            grid-column: span 2;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            margin-left: 0.5rem;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
    </style>
</body>
</html>
